"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var childProcess = require("child_process");
var split = require("split");
var logger_1 = require("../logger");
exports.executeWith = function (args) { return function (pathToBinary) { return new Promise(function (resolve, reject) {
    function withAdviseOn(output) {
        switch (true) {
            case output.indexOf('jarfile') > 0:
                return 'Did you remember to run `serenity update`? ' + output;
            case output.indexOf('Unsupported major.minor version') >= 0:
                return 'Looks like you\'re using an old version of Java? Serenity BDD needs Java 8 or newer.';
            default:
                return output;
        }
    }
    function log(output) {
        var interestingPartOf = function (line, after) { return line.substring(line.indexOf(after) + after.length + 1); };
        switch (true) {
            case output.indexOf('DEBUG') >= 0:
                logger_1.logger.debug(interestingPartOf(output, 'DEBUG'));
                break;
            case output.indexOf('WARN') >= 0:
                logger_1.logger.warn(interestingPartOf(output, 'WARN'));
                break;
            case output.indexOf('INFO') >= 0:
                logger_1.logger.log('verbose', interestingPartOf(output, 'INFO'));
                break;
            case output.length > 0:
                logger_1.logger.log('verbose', output);
                break;
            default:
                break;
        }
    }
    var spawned = childProcess.spawn(pathToBinary, args);
    spawned.stdout.pipe(split()).on('data', log);
    spawned.stderr.pipe(split()).on('data', function (problem) {
        if (problem.length > 0) {
            reject(new Error(withAdviseOn(problem)));
        }
    });
    spawned.on('close', function (exitCode) {
        if (exitCode !== 0) {
            reject(new Error(pathToBinary + " process exited with code " + exitCode));
        }
        else {
            resolve(true);
        }
    });
}); }; };
//# sourceMappingURL=process.js.map